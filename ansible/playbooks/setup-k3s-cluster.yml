# Ansible Playbook: K3s Cluster Setup
# Use Case: When you need to configure multiple nodes consistently
# Run: ansible-playbook -i inventory.yml playbooks/setup-k3s-cluster.yml
---
- name: Setup K3s Cluster - Common Tasks
  hosts: k3s_cluster
  become: yes
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - git
          - jq
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present

    - name: Disable swap
      command: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '.*swap.*'
        state: absent

    - name: Load required kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay

    - name: Persist kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          br_netfilter
          overlay

    - name: Set sysctl parameters
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv4.ip_forward', value: '1' }

- name: Setup K3s Master Node
  hosts: masters
  become: yes
  vars:
    k3s_token: "{{ lookup('password', '/tmp/k3s_token chars=ascii_letters,digits length=32') }}"
  tasks:
    - name: Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_installed

    - name: Install K3s server
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.28.5+k3s1 sh -s - server \
          --token="{{ k3s_token }}" \
          --write-kubeconfig-mode=644 \
          --disable=traefik \
          --node-name=master \
          --tls-san={{ ansible_host }}
      when: not k3s_installed.stat.exists

    - name: Wait for K3s to be ready
      wait_for:
        path: /etc/rancher/k3s/k3s.yaml
        state: present
        timeout: 300

    - name: Get K3s token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_node_token

    - name: Save K3s token to local file
      copy:
        content: "{{ k3s_node_token.content | b64decode }}"
        dest: /tmp/k3s_token.txt
      delegate_to: localhost
      become: no
      

    - name: Install Helm
      shell: |
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Create namespaces
      shell: |
        kubectl create namespace {{ item }} || true
      loop:
        - argocd
        - monitoring
        - logging
        - lms
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Setup K3s Worker Nodes
  hosts: workers
  become: yes
  vars:
    master_ip: "{{ hostvars['k3s-master']['ansible_host'] }}"
  tasks:
    - name: Read K3s token
      set_fact:
        k3s_token: "{{ lookup('file', '/tmp/k3s_token.txt') }}"

    - name: Check if K3s agent is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_installed

    - name: Wait for master to be ready
      wait_for:
        host: "{{ master_ip }}"
        port: 6443
        timeout: 300

    - name: Install K3s agent
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.28.5+k3s1 \
          K3S_URL=https://{{ master_ip }}:6443 \
          K3S_TOKEN={{ k3s_token }} \
          sh -s - agent --node-name={{ inventory_hostname }}
      when: not k3s_installed.stat.exists

- name: Verify Cluster
  hosts: masters
  become: yes
  tasks:
    - name: Wait for all nodes to be ready
      shell: kubectl get nodes --no-headers | grep -c "Ready"
      register: ready_nodes
      until: ready_nodes.stdout | int >= 3
      retries: 30
      delay: 10
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Display cluster status
      shell: kubectl get nodes -o wide
      register: cluster_status
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Show cluster status
      debug:
        msg: "{{ cluster_status.stdout_lines }}"
